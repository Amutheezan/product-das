<%

(function () {
	var TYPE = "type";
	var CONTENT_TYPE_JSON = "application/json";
	var AUTHORIZATION_HEADER = "Authorization";
	var USER_TOKEN = "user";
	var USERNAME = "username";
	var DOMAIN = "domain";
	var HTTP_USER_NOT_AUTHENTICATED = 403;
	var HTTP_INTERNAL_ERROR = 500;
	var log = new Log();
	var carbon = require('carbon');
	var configs = require('/configs/designer.json');
	var utils = require('/modules/utils.js');
	var hl7Utils=require('hl7-utils.jag');
	var server = new carbon.server.Server();
	var timeRangeUtil = Packages.org.wso2.analytics.esb.util.TimeRangeUtils;
	var timeRange = Packages.org.wso2.analytics.esb.bean.TimeRange;
	var JSUtils = Packages.org.wso2.carbon.analytics.jsservice.Utils;
	var AnalyticsCachedJSServiceConnector = Packages.org.wso2.carbon.analytics.jsservice.AnalyticsCachedJSServiceConnector;
	var AnalyticsCache = Packages.org.wso2.carbon.analytics.jsservice.AnalyticsCachedJSServiceConnector.AnalyticsCache;
	var eventProcessorService = carbon.server.osgiService('org.wso2.carbon.event.processor.core.EventProcessorService');
	var eventPublisherService = carbon.server.osgiService('org.wso2.carbon.event.publisher.core.EventPublisherService')
	var cacheTimeoutSeconds = 5;
	var loggedInUser = null;
	var tenantId = -1;
	var superTenantId = -1234;


	var SUMMARY_CHART=1;
	var SEARCH_TABLE=2;
	var SEARCH_SPECIFIC_MESSAGE=20;
	var NOTIFY_DISEASE=3;
	var NOTIFY_WAIT_TIME=30;
    	var UPDATE_ALERT=31;
	var CURRENT_SETTING=32;



	if (configs.cacheTimeoutSeconds) {
		cacheTimeoutSeconds = parseInt(configs.cacheTimeoutSeconds);
	}
	var cacheSizeBytes = 1024 * 1024 * 1024;
	if (configs.cacheSizeBytes) {
		cacheSizeBytes = parseInt(configs.cacheSizeBytes);
	}

	response.contentType = CONTENT_TYPE_JSON;

	var authParam = request.getHeader(AUTHORIZATION_HEADER);
	if (authParam != null) {
		credentials = JSUtils.authenticate(authParam);
		loggedInUser = credentials[0];
	} else {
		var token = session.get(USER_TOKEN);
		if (token != null) {
			loggedInUser = token[USERNAME] + "@" + token[DOMAIN] ;
		} else {
			log.error("user is not authenticated!");
			response.status = HTTP_USER_NOT_AUTHENTICATED;
			print('{ "status": "Failed", "message": "User is not authenticated." }');
			return;
		}
	}
	var user = carbon.server.tenantUser(loggedInUser);
	tenantId = user.tenantId;

	var cache = application.get("AnalyticsWebServiceCache");
	if (cache == null) {
		cache = new AnalyticsCache(cacheTimeoutSeconds, cacheSizeBytes);
		application.put("AnalyticsWebServiceCache", cache);
	}

	var connector = new AnalyticsCachedJSServiceConnector(cache);

	var type = 0;
	var typeParam = request.getParameter(TYPE);
	if (typeParam != null) {
		type = parseInt(typeParam);
	}
	if (type == 0) {
		log.error("operation type is not specified!");
		response.status = HTTP_INTERNAL_ERROR;
		print('{ "status": "Failed", "message": "Operation type is not specified" }');
		return;
	}

	var content = request.getContent();
	if (content != '' && content != null) {
		if (log.isDebugEnabled()) {
			log.debug("value of content: " + stringify(contentAsString));
		}
	}

	if (connector != null && loggedInUser != null) {
	var result = [];
	var temp=[];
	var query = null;
	var resp = null;
		switch(type){
			case SUMMARY_CHART:
			{
				var timeFrom = request.getParameter("timeFrom");
				var timeTo = request.getParameter("timeTo");
				var msgType = request.getParameter("msgType");
				var tableSuffix = request.getParameter("suf");
				var timeUnit = timeRangeUtil.getSuitableTimeRangeUnit(timeFrom, timeTo);
				if(tableSuffix == null){
					tableSuffix="";
				}
				var tableName = "DAS_HL7_DATA_PUBLISHER_STORE_PER" + timeUnit + tableSuffix;
				timeFrom = timeRangeUtil.roundFloor(timeFrom, timeUnit);
				query = stringify({
					query: "Type:" + msgType + " AND timestamp : [" + timeFrom + " TO " + timeTo + "]",
					"start": 0,
					"count": 200
				});
				resp = connector.search(superTenantId, tableName, query);

					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}

					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								result.push({
									"timestamp": obj.values.timestamp,
									"msgCount": obj.values.msgCount,
									"SubType" : obj.values.SubType

								});
							}
						}
					}
		        break;
			 }

			case SEARCH_TABLE:
			{
				var timeFrom = request.getParameter("timeFrom");
				var timeTo = request.getParameter("timeTo");
				var querytxt = request.getParameter("query");
				var maxrows = request.getParameter("maxRows");
				var timeUnit = timeRangeUtil.getSuitableTimeRangeUnit(timeFrom, timeTo);
				var tableName = "DAS_HL7_DATA_PUBLISHER_STORE";
				timeFrom = timeRangeUtil.roundFloor(timeFrom, timeUnit);
				query = stringify({
					query: "timestamp : [" + timeFrom + " TO " + timeTo + "] " + querytxt,
					"start": 0,
					"count": maxrows
				});
				resp = connector.search(superTenantId, tableName, query);
    				var count = connector.searchCount(superTenantId,  tableName, query);
    				var limit = count.getMessage();
					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}
					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								temp.push(obj.values);
							}
						}
					}
					result.push({"draw" : 1,
					"recordsFiltered" : limit,
     		  					"recordsTotal" : limit,
     		  					"data" : temp});


				break;
			 }
			 case SEARCH_SPECIFIC_MESSAGE:
			{
				var timeFrom = request.getParameter("timeFrom");
				var timeTo = request.getParameter("timeTo");
				var querytxt = request.getParameter("query");
				var correlation_activity_id = request.getParameter("correlation_activity_id");
				var timeUnit = timeRangeUtil.getSuitableTimeRangeUnit(timeFrom, timeTo);
				var tableName = "DAS_HL7_DATA_PUBLISHER_STORE";
				timeFrom = timeRangeUtil.roundFloor(timeFrom, timeUnit);
				query = stringify({
					query: "timestamp : [" + timeFrom + " TO " + timeTo + "] " + querytxt + "AND correlation_activity_id : " + correlation_activity_id,
					"start": 0,
					"count": 1000
				});
				resp = connector.search(superTenantId, tableName, query);
					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}
					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								result.push(obj.values);
							}
						}
					}
				break;
			 }

			case NOTIFY_DISEASE:
			{
                var diseaseType=request.getParameter("diseaseType");
				var tableName = "DISEASEALERTING";
				if (hl7Utils.isNull(diseaseType)){
				query = stringify({
					query: "*:*",
					"start": 0,
					"count": 100
				});
				}else if (diseaseType == "ALL"){
				query = stringify({
					query: "*:*",
					"start": 0,
					"count": 100
				});
				}else{
				query = stringify({
					query: "_DiagnosisDescription : " + diseaseType,
					"start": 0,
					"count": 100
				});
				}
				resp = connector.search(superTenantId, tableName, query);
    				var count = connector.searchCount(superTenantId,  tableName, query);
    				var limit = count.getMessage();
					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}
					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								temp.push(obj.values);
							}
						}
					}
					result.push({"draw" : 1,
					"recordsFiltered" : limit,
     		  					"recordsTotal" : limit,
     		  					"data" : temp});
					break;
			 }
			 case NOTIFY_WAIT_TIME:
			{
				var tableName = "WAITTIMEALERTING";
				query = stringify({
					query: "*:*",
					"start": 0,
					"count": 100
				});
				resp = connector.search(superTenantId, tableName, query);
    				var count = connector.searchCount(superTenantId,  tableName, query);
    				var limit = count.getMessage();
					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}
					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								temp.push(obj.values);
							}
						}
					}
					result.push({"draw" : 1,
					"recordsFiltered" : limit,
     		  					"recordsTotal" : limit,
     		  					"data" : temp});
					break;
			 }
			 case UPDATE_ALERT:
			 {
				   var initialize="Update";
				   var alertType=request.getParameter("AlertType");
					 var AlertLimit=request.getParameter("AlertLimit");
					 var EmailAddress=request.getParameter("EmailAddress");
					 var PhoneNo=request.getParameter("PhoneNo");
					 var executionPlanName=alertType+"Alerts";
					 var smsAlertName="sms"+alertType;
					 var emailAlertName="email"+alertType;
					try{
						eventProcessorService.undeployActiveExecutionPlan(executionPlanName);
						initialize="Update"
					}catch(e){
						initialize="Initialize"
						log.error(e.message);
					}

					 var executionPlan=hl7Utils.getExecutionPlan(alertType);
					 executionPlan=executionPlan.replace("$AlertLimit", AlertLimit);
					 eventProcessorService.deployExecutionPlan(executionPlan);
                     if(hl7Utils.isNull(PhoneNo) == false){
							     try{
									 eventPublisherService.undeployActiveEventPublisherConfiguration(smsAlertName);
									 initialize="Update"
								 }catch(e){
									 initialize="Initialize"
									 log.error(e.message);
								 }
						var smsPublisher=hl7Utils.getSmsPublisher(alertType);
						smsPublisher=smsPublisher.replace("$PhoneNo",PhoneNo);
						eventPublisherService.deployEventPublisherConfiguration(smsPublisher);
					 }
					 if(hl7Utils.isNull(EmailAddress) == false){
							    try{
									eventPublisherService.undeployActiveEventPublisherConfiguration(emailAlertName);
									initialize="Update"
								}catch(e){
									initialize="Initialize"
									log.error(e.message);
								}
					 var emailPublisher=hl7Utils.getEmailPublisher(alertType);
					 emailPublisher=emailPublisher.replace("$EmailAddress",EmailAddress);
					 eventPublisherService.deployEventPublisherConfiguration(emailPublisher);
					}
					 result.push({"initialize":initialize});
					 break;

			 }
			 case CURRENT_SETTING :
						 {
						 var tempExecutionPlanDiseaseAlert, tempExecutionPlanWaitTimeAlert=null;
						 var tempPublisherSmsDisease, tempPublisherSmsWaitTime,tempPublisherEmailDisease, tempPublisherEmailWaitTime=null;
						 var diseaseAlertLimit=1000;
						 var waitTimeAlertLimit=1000;
						 var initializeDisease="Update";
						 var initializeWaitTime="Update";
						 var emailDisease;
						 var emailWaitTime;
						 var smsDisease;
						 var smsWaitTime;

							try{
							 		tempExecutionPlanDiseaseAlert=eventProcessorService.getActiveExecutionPlan("diseaseAlerts")
							}catch(e){
							    initializeDisease="Initialize"
									log.error(e.message);
							}

							if(hl7Utils.isNull(tempExecutionPlanDiseaseAlert)== false){
								 tempExecutionPlanDiseaseAlert=tempExecutionPlanDiseaseAlert.split(" ");
								 for(var i=0;i< tempExecutionPlanDiseaseAlert.length;i++){
										 if(tempExecutionPlanDiseaseAlert[i]== ">"){
													 diseaseAlertLimit = tempExecutionPlanDiseaseAlert[i+1];
										}
								 }
							}

							try{
									tempExecutionPlanWaitTimeAlert=eventProcessorService.getActiveExecutionPlan("waitTimeAlerts")
							}catch(e){
									initializeWaitTime="Initialize"
									log.error(e.message);
							}

												if(hl7Utils.isNull(tempExecutionPlanWaitTimeAlert)== false){
													 tempExecutionPlanWaitTimeAlert=tempExecutionPlanWaitTimeAlert.split(" ");
													 for(var i=0;i< tempExecutionPlanWaitTimeAlert.length;i++){
															 if(tempExecutionPlanWaitTimeAlert[i]== ">"){
																		 waitTimeAlertLimit = tempExecutionPlanWaitTimeAlert[i+1];
															}
													 }
												}
							try{
								tempPublisherSmsDisease=eventPublisherService.getActiveEventPublisherConfigurationContent("smsdisease")
							}catch(e){
									log.error(e.message);
							}
							if(hl7Utils.isNull(tempPublisherSmsDisease)== false){
								 tempPublisherSmsDisease=tempPublisherSmsDisease.split(" ");
								 for(var i=0;i< tempPublisherSmsDisease.length;i++){
										 if(tempPublisherSmsDisease[i]== 'name="sms.no">'){
													 smsDisease = tempPublisherSmsDisease[i+1];
										}
								 }
							}
							try{
								tempPublisherSmsWaitTime=eventPublisherService.getActiveEventPublisherConfigurationContent("smswaitTime")
							}catch(e){
									log.error(e.message);
							}
							if(hl7Utils.isNull(tempPublisherSmsWaitTime)== false){
								 tempPublisherSmsWaitTime=tempPublisherSmsWaitTime.split(" ");
								 for(var i=0;i< tempPublisherSmsWaitTime.length;i++){
										 if(tempPublisherSmsWaitTime[i]== 'name="sms.no">'){
													 smsWaitTime = tempPublisherSmsWaitTime[i+1];
										}
								 }
							}

							try{
								tempPublisherEmailDisease=eventPublisherService.getActiveEventPublisherConfigurationContent("emaildisease")
							}catch(e){
									log.error(e.message);
							}
							if(hl7Utils.isNull(tempPublisherEmailDisease)== false){
								 tempPublisherEmailDisease=tempPublisherEmailDisease.split(" ");
								 for(var i=0;i< tempPublisherEmailDisease.length;i++){
										 if(tempPublisherEmailDisease[i]== 'name="email.address">'){
													 emailDisease = tempPublisherEmailDisease[i+1];
										}
								 }
							}
							try{
								tempPublisherEmailWaitTime=eventPublisherService.getActiveEventPublisherConfigurationContent("emailwaitTime")
							}catch(e){
									log.error(e.message);
							}
							if(hl7Utils.isNull(tempPublisherEmailWaitTime)== false){
								 tempPublisherEmailWaitTime=tempPublisherEmailWaitTime.split(" ");
								 for(var i=0;i< tempPublisherEmailWaitTime.length;i++){
										 if(tempPublisherEmailWaitTime[i]== 'name="email.address">'){
													 emailWaitTime = tempPublisherEmailWaitTime[i+1];
										}
								 }
							}

						if(emailDisease == "null"){
							emailDisease="";
						}
						if(emailWaitTime == "null"){
							emailWaitTime="";
						}
						if(smsDisease == "null"){
							smsDisease="";
						}
						if(smsWaitTime == "null"){
							smsWaitTime="";
						}

							result.push({"diseaseAlertLimit": diseaseAlertLimit,
													"waitTimeAlertLimit": waitTimeAlertLimit,
													"initializeDisease": initializeDisease,
													"initializeWaitTime": initializeWaitTime,
													"emailDisease":emailDisease,
													"emailWaitTime":emailWaitTime,
													"smsDisease":smsDisease,
													"smsWaitTime":smsWaitTime
													});
							break;
						 }

			default :
			{
				result = '{ "status": "Failed", "message": "Unidentified operation" }';
				break;
			}
		     }

			if (result != null) {
					if (log.isDebugEnabled()) {
						log.debug("value of result: " + result);
					}

						var finalResult = {
							status: "success",
							message: result
						}
					print(finalResult);
					}
		}
}());
%>
