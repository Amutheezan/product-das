<%
(function () {
	var TYPE = "type";
	var CONTENT_TYPE_JSON = "application/json";
	var AUTHORIZATION_HEADER = "Authorization";
	var USER_TOKEN = "user";
	var USERNAME = "username";
	var DOMAIN = "domain";
	var HTTP_USER_NOT_AUTHENTICATED = 403;
	var HTTP_INTERNAL_ERROR = 500;
	var log = new Log();
	var carbon = require('carbon');
	var configs = require('/configs/designer.json');
	var utils = require('/modules/utils.js');
	var server = new carbon.server.Server();
	var timeRangeUtil = Packages.org.wso2.analytics.esb.util.TimeRangeUtils;
	var timeRange = Packages.org.wso2.analytics.esb.bean.TimeRange;
	var JSUtils = Packages.org.wso2.carbon.analytics.jsservice.Utils;
	var AnalyticsCachedJSServiceConnector = Packages.org.wso2.carbon.analytics.jsservice.AnalyticsCachedJSServiceConnector;
	var AnalyticsCache = Packages.org.wso2.carbon.analytics.jsservice.AnalyticsCachedJSServiceConnector.AnalyticsCache;
	var eventProcessorService = carbon.server.osgiService('org.wso2.carbon.event.processor.core.EventProcessorService');

	var cacheTimeoutSeconds = 5;
	var loggedInUser = null;
	var tenantId = -1;
	var superTenantId = -1234;


	var SUMMARY_CHART=1;
	var SEARCH_TABLE=2;
	var SEARCH_SPECIFIC_MESSAGE=20;
	var NOTIFY_DISEASE=3;
	var NOTIFY_WAIT_TIME=30;
  	var DEPLOY_EXECUTION_PLAN=31;
	var CURRENT_EXECUTION_PLAN=32;

	if (configs.cacheTimeoutSeconds) {
		cacheTimeoutSeconds = parseInt(configs.cacheTimeoutSeconds);
	}
	var cacheSizeBytes = 1024 * 1024 * 1024;
	if (configs.cacheSizeBytes) {
		cacheSizeBytes = parseInt(configs.cacheSizeBytes);
	}

	response.contentType = CONTENT_TYPE_JSON;

	var authParam = request.getHeader(AUTHORIZATION_HEADER);
	if (authParam != null) {
		credentials = JSUtils.authenticate(authParam);
		loggedInUser = credentials[0];
	} else {
		var token = session.get(USER_TOKEN);
		if (token != null) {
			loggedInUser = token[USERNAME] + "@" + token[DOMAIN] ;
		} else {
			log.error("user is not authenticated!");
			response.status = HTTP_USER_NOT_AUTHENTICATED;
			print('{ "status": "Failed", "message": "User is not authenticated." }');
			return;
		}
	}
	var user = carbon.server.tenantUser(loggedInUser);
	tenantId = user.tenantId;

	var cache = application.get("AnalyticsWebServiceCache");
	if (cache == null) {
		cache = new AnalyticsCache(cacheTimeoutSeconds, cacheSizeBytes);
		application.put("AnalyticsWebServiceCache", cache);
	}

	var connector = new AnalyticsCachedJSServiceConnector(cache);

	var type = 0;
	var typeParam = request.getParameter(TYPE);
	if (typeParam != null) {
		type = parseInt(typeParam);
	}
	if (type == 0) {
		log.error("operation type is not specified!");
		response.status = HTTP_INTERNAL_ERROR;
		print('{ "status": "Failed", "message": "Operation type is not specified" }');
		return;
	}

	var content = request.getContent();
	if (content != '' && content != null) {
		if (log.isDebugEnabled()) {
			log.debug("value of content: " + stringify(contentAsString));
		}
	}

	if (connector != null && loggedInUser != null) {
	var result = [];
	var temp=[];
	var query = null;
	var resp = null;
		switch(type){
			case SUMMARY_CHART:
			{
				var timeFrom = request.getParameter("timeFrom");
				var timeTo = request.getParameter("timeTo");
				var msgType = request.getParameter("msgType");
				var tableSuffix = request.getParameter("suf");
				var timeUnit = timeRangeUtil.getSuitableTimeRangeUnit(timeFrom, timeTo);
				if(tableSuffix == null){
					tableSuffix="";
				}
				var tableName = "DAS_HL7_DATA_PUBLISHER_STORE_PER" + timeUnit + tableSuffix;
				timeFrom = timeRangeUtil.roundFloor(timeFrom, timeUnit);
				query = stringify({
					query: "Type:" + msgType + " AND timestamp : [" + timeFrom + " TO " + timeTo + "]",
					"start": 0,
					"count": 200
				});
				resp = connector.search(superTenantId, tableName, query);

					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}

					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								result.push({
									"timestamp": obj.values.timestamp,
									"msgCount": obj.values.msgCount,
									"SubType" : obj.values.SubType

								});
							}
						}
					}

		break;
			 }

			case SEARCH_TABLE:
			{
				var timeFrom = request.getParameter("timeFrom");
				var timeTo = request.getParameter("timeTo");
				var querytxt = request.getParameter("query");
				var maxrows = request.getParameter("maxRows");
				var timeUnit = timeRangeUtil.getSuitableTimeRangeUnit(timeFrom, timeTo);
				var tableName = "DAS_HL7_DATA_PUBLISHER_STORE";
				timeFrom = timeRangeUtil.roundFloor(timeFrom, timeUnit);
				query = stringify({
					query: "timestamp : [" + timeFrom + " TO " + timeTo + "] " + querytxt,
					"start": 0,
					"count": maxrows
				});
				resp = connector.search(superTenantId, tableName, query);
    				var count = connector.searchCount(superTenantId,  tableName, query);
    				var limit = count.getMessage();
					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}
					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								temp.push(obj.values);
							}
						}
					}
					result.push({"draw" : 1,
					"recordsFiltered" : limit,
     		  					"recordsTotal" : limit,
     		  					"data" : temp});


					break;
			 }
			 case SEARCH_SPECIFIC_MESSAGE:
			{
				var timeFrom = request.getParameter("timeFrom");
				var timeTo = request.getParameter("timeTo");
				var querytxt = request.getParameter("query");
				var correlation_activity_id = request.getParameter("correlation_activity_id");
				var timeUnit = timeRangeUtil.getSuitableTimeRangeUnit(timeFrom, timeTo);
				var tableName = "DAS_HL7_DATA_PUBLISHER_STORE";
				timeFrom = timeRangeUtil.roundFloor(timeFrom, timeUnit);
				query = stringify({
					query: "timestamp : [" + timeFrom + " TO " + timeTo + "] " + querytxt + "AND correlation_activity_id : " + correlation_activity_id,
					"start": 0,
					"count": 1000
				});
				resp = connector.search(superTenantId, tableName, query);
					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}
					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								result.push(obj.values);
							}
						}
					}
					break;
			 }

			 			case NOTIFY_DISEASE:
			{

				var tableName = "DISEASEALERTING";
				query = stringify({
					query: "*:*",
					"start": 0,
					"count": 100
				});
				resp = connector.search(superTenantId, tableName, query);
    				var count = connector.searchCount(superTenantId,  tableName, query);
    				var limit = count.getMessage();
					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}
					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								temp.push(obj.values);
							}
						}
					}
					result.push({"draw" : 1,
					"recordsFiltered" : limit,
     		  					"recordsTotal" : limit,
     		  					"data" : temp});
					break;
			 }
			 case NOTIFY_WAIT_TIME:
			{

				var tableName = "WAITTIMEALERTING";
				query = stringify({
					query: "*:*",
					"start": 0,
					"count": 100
				});
				resp = connector.search(superTenantId, tableName, query);
    				var count = connector.searchCount(superTenantId,  tableName, query);
    				var limit = count.getMessage();
					var dataPoints = [];
					try {
						dataPoints = JSON.parse(resp.getMessage());
					} catch (error) {
						log.error(error);
					}
					for (var i = 0; i < dataPoints.length; i++) {
						var obj = dataPoints[i];
						if (obj != null && obj.values != null) {
							if (obj != null) {
								temp.push(obj.values);
							}
						}
					}
					result.push({"draw" : 1,
					"recordsFiltered" : limit,
     		  					"recordsTotal" : limit,
     		  					"data" : temp});


					break;
			 }
			 case DEPLOY_EXECUTION_PLAN:
			 {
			  var initialize="Update Setting";
			 		try{
						eventProcessorService.undeployActiveExecutionPlan("hl7alerts");
					}catch(e){
						initialize="Initialize Setting"
						log.error(e.message);
					}
			     var diseaseAlertLimit=request.getParameter("diseaseAlertLimit");
			     var waitTimeAlertLimit=request.getParameter("waitTimeAlertLimit");
			     var executionPlan=getExecutionPlan();
					 executionPlan=executionPlan.replace("$diseaseAlertLimit", diseaseAlertLimit);
					 executionPlan=executionPlan.replace("$waitTimeAlertLimit",waitTimeAlertLimit)
				   eventProcessorService.deployExecutionPlan(executionPlan);
				   result.push({"initialize":initialize});
				   break;

			 }
			 case CURRENT_EXECUTION_PLAN :
			 {
			 var tempExecutionPlan=null;
			 var setDiseaseAlert=false;
			 var diseaseAlertLimit=1000;
			 var waitTimeAlertLimit=1000;
			 var initialize="Update Setting"
				try{
				 		tempExecutionPlan=eventProcessorService.getActiveExecutionPlan("hl7alerts")
				}catch(e){
				    initialize="Initialize Setting"
						log.error(e.message);
				}
				if(isNull(tempExecutionPlan)== false){
					 tempExecutionPlan=tempExecutionPlan.split(" ");
			 		 for(var i=0;i< tempExecutionPlan.length;i++){
					 		 if(tempExecutionPlan[i]== ">"){
						 		 if(setDiseaseAlert==true){
								 		 waitTimeAlertLimit = tempExecutionPlan[i+1];
						 		 }else{
								 		 diseaseAlertLimit = tempExecutionPlan[i+1];
								 		 setDiseaseAlert = true;
						 		 }
					 		 }
			 		 }
				}
				result.push({"diseaseAlertLimit": diseaseAlertLimit, "waitTimeAlertLimit": waitTimeAlertLimit,"initialize":initialize});
				break;
			 }

			default :
			{
				result = '{ "status": "Failed", "message": "Unidentified operation" }';
				break;
			}
		     }

			if (result != null) {
					if (log.isDebugEnabled()) {
						log.debug("value of result: " + result);
					}

						var finalResult = {
							status: "success",
							message: result
						}
					print(finalResult);
					}
		}
}());
function getExecutionPlan(){
	var temp="@Plan:name('hl7alerts')" +"\n"+"\n"
	+"@Plan:description('Disease Alerting and Wait Time Alerting')"+"\n"+"\n"
	+"@Plan:statistics('true')"+"\n"+"\n"
	+"@Plan:trace('true')"+"\n"+"\n"
	+"@Import('das_hl7_data_publisher_store:1.0.0', arbitrary.data='true')"+"\n"
	+"define stream dashl7msg (meta_host string, meta_server_name string,"+"\n"
	+"correlation_activity_id string,"+"\n"
	+"content string, type string, timestamp long, message_direction string,"+"\n"
	+"service_name string, operation_name string, status string, arbitraryDataMap object);"+"\n"+"\n"
	+"@Export('diseaseAlerting:1.0.0')"+"\n"
	+"define stream diseaseAlerting (latitude double,longitude double,formattedAddress string, Disease string,msgCount long, timestamp long);"+"\n"+"\n"
	+"@Export('waitTimeAlerting:1.0.0')"+"\n"
	+"define stream waitTimeAlerting (waitingTime long, registeredTime long);"+"\n"+"\n"
	+"from dashl7msg"+"\n"
	+"[(cast(map:get(arbitraryDataMap, 'MSH.MessageType'),'string') != 'ACK') AND"+"\n"
	+"(NOT(cast(map:get(arbitraryDataMap, 'PID.PatientAddress'), 'string') is null))  AND"+"\n"
		+"(NOT(cast(map:get(arbitraryDataMap, 'PID.PatientAddress[2]'), 'string') is null))  AND"+"\n"
			+"(NOT(cast(map:get(arbitraryDataMap, 'PID.PatientAddress[3]'), 'string') is null))  AND"+"\n"
	+"(NOT(cast(map:get(arbitraryDataMap, 'PID.PatientAddress[4]'), 'string') is null)) AND"+"\n"
	+"(NOT (cast(map:get(arbitraryDataMap, 'PID.PatientAddress[5]'), 'string') is null)) AND"+"\n"
	+"(NOT(cast(map:get(arbitraryDataMap, 'DG1.DiagnosisDescription'), 'string') is null)) AND"+"\n"
		+"(NOT(cast(map:get(arbitraryDataMap, 'MSH.Date/TimeofMessage'),'string') is null))]"+"\n"
		
	+"select cast(map:get(arbitraryDataMap, 'PID.PatientAddress'), 'string') as Address,"+"\n"
		+"cast(map:get(arbitraryDataMap, 'PID.PatientAddress[2]'), 'string') as City,"+"\n"
	+"cast(map:get(arbitraryDataMap, 'PID.PatientAddress[3]'), 'string') as State,"+"\n"
		+"cast(map:get(arbitraryDataMap, 'PID.PatientAddress[3]'), 'string') as ZipCode,"+"\n"
	+"cast(map:get(arbitraryDataMap, 'PID.PatientAddress[5]'), 'string') as Country,"+"\n"
	+"cast(map:get(arbitraryDataMap, 'DG1.DiagnosisDescription'), 'string') as Disease ,"+"\n"
+"time:timestampInMilliseconds(cast(map:get(arbitraryDataMap, 'MSH.Date/TimeofMessage'),'string'),'yyyyMMDDHHMMss.SSS') as timestamp" + "\n"
	+"insert into diseaseAlert;"+"\n"+"\n"
	+"from diseaseAlert#window.time(1 day)"+"\n"
	+"select Address,City,State,ZipCode,Country,Disease, count(*) as msgCount,timestamp"+"\n"
	+"group by Address,City,State,ZipCode,Country,Disease"+"\n"
	+"insert into diseaseAlertTemp;"+"\n"+"\n"
+"from diseaseAlertTemp[msgCount > $diseaseAlertLimit "+" ]"+"\n"
+"select str:concat( Address,', ',City,', ',State,' ',ZipCode,', ',Country) as location,Disease,msgCount,timestamp"+"\n"
+"insert into diseaseLocalAlertTemp;"+"\n"
+"from diseaseLocalAlertTemp#geo:geocode(location)"+"\n"
+"select latitude, longitude,formattedAddress,Disease, msgCount,timestamp"+"\n"

+"insert into diseaseAlerting;"+"\n"+"\n"
	+"from dashl7msg"+"\n"
	+"[(cast(map:get(arbitraryDataMap, 'MSH.MessageType'),'string') == 'ADT') AND "+"\n"
	+"(cast(map:get(arbitraryDataMap, 'MSH.MessageType[1]'),'string') == 'A01') AND "+"\n"
	+"(NOT(cast(map:get(arbitraryDataMap, 'PID.PatientID(InternalID)'), 'string') is null)) AND "+"\n"
	 +"(NOT(cast(map:get(arbitraryDataMap, 'PV1.VisitNumber'), 'string') is null)) AND "+"\n"
	+"(NOT(cast(map:get(arbitraryDataMap, 'MSH.Date/TimeofMessage'),'string') is null))]"+"\n"
	+"select cast(map:get(arbitraryDataMap, 'PID.PatientID(InternalID)'),'string') as PatientID, "+"\n"
	+"cast(map:get(arbitraryDataMap, 'PV1.VisitNumber'),'string') as VisitNo,"+"\n"
	+"time:timestampInMilliseconds(cast(map:get(arbitraryDataMap, 'MSH.Date/TimeofMessage'),'string'),'yyyyMMDDHHMMss.SSS') as timestamp" + "\n"
	+"insert into admissionRecords;"+"\n"+"\n"
	+"from dashl7msg"+"\n"
	+"[(cast(map:get(arbitraryDataMap, 'MSH.MessageType'),'string') == 'ADT') AND "+"\n"
	+"(cast(map:get(arbitraryDataMap, 'MSH.MessageType[1]'),'string') == 'A04') AND "+"\n"
	+"(NOT(cast(map:get(arbitraryDataMap, 'PID.PatientID(InternalID)'), 'string') is null)) AND "+"\n"
	 +"(NOT(cast(map:get(arbitraryDataMap, 'PV1.VisitNumber'), 'string') is null)) AND "+"\n"
	+"(NOT(cast(map:get(arbitraryDataMap, 'MSH.Date/TimeofMessage'),'string') is null))]"+"\n"
	+"select cast(map:get(arbitraryDataMap, 'PID.PatientID(InternalID)'),'string') as PatientID,"+"\n"
	+"cast(map:get(arbitraryDataMap, 'PV1.VisitNumber'),'string') as VisitNo,"+"\n"
	+"time:timestampInMilliseconds(cast(map:get(arbitraryDataMap, 'MSH.Date/TimeofMessage'),'string'),'yyyyMMDDHHMMss.SSS') as timestamp"+"\n"
	+"insert into registerRecords;"+"\n"+"\n"
	+"from admissionRecords#window.length(1000) as ar join registerRecords as rr on"+"\n"
	+"((ar.PatientID == rr.PatientID)AND(ar.VisitNo==rr.VisitNo))"+"\n"
	+"select rr.timestamp-ar.timestamp as waitingTime, rr.timestamp as registeredTime"+"\n"
	+"insert into waitTimeAlert;"+"\n"+"\n"
	+"from waitTimeAlert[waitingTime > $waitTimeAlertLimit"+"000 "+ "]"+"\n"
	+"select waitingTime, registeredTime"+"\n"
	+"insert into waitTimeAlerting;"
	return temp;
}
function isNull(value){
  var isNull=false;
  if(typeof value === "undefined" || value === null || value === "" ){
    isNull=true;
  }
  return isNull;
}

%>
