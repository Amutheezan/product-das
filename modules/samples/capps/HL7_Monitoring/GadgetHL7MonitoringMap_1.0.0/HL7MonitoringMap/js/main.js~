var url= "/portal/store/carbon.super/fs/gadget/HL7MonitoringGadgetCommon/jaggery-api/hl7.jag";
var mymap;
var TOPIC="subscriber";
window.onload=function(){
$.ajax({
    url: url +"?type=3",
    type: "GET",
    success: function(data) {
       onData(data);

    },
    error: function(data){
    }

});
}


gadgets.HubSettings.onConnect = function() {
    gadgets.Hub.subscribe(TOPIC, function(topic, data, subscriberData) {
        onDataChanged(data);
    });
};


function onDataChanged(data){
var diseaseType=data.diseaseType;
$.ajax({
    url: url +"?type=3&disease="+diseaseType,
    type: "GET",
    success: function(data) {
       onData(data);

    },
    error: function(data){
    }

});
}
setTimeout( function() {

mymap = L.map('mapid').setView([45, -180], 1);
L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox.satellite',
    accessToken: 'pk.eyJ1IjoiYW11dGhlZXphbjkzIiwiYSI6ImNpd2dlOHQyOTAxNzUydG1tMGV4Z21jZnQifQ.Vyh1OXwNBgFz1nMVjSe41A'
}).addTo(mymap);
}, 10);

function onData(data){

var result=data.message[0].data;
console.log(result);
for(var i=0;i<result.length;i++){
if(isNull(result[i]["latitude"])){
console.log("latitude is null");
}else if( isNull(result[i]["longitude"])){
}else{
console.log("success");
var marker = L.marker([result[i]["latitude"], result[i]["longitude"]]).addTo(mymap);

}
}

}

function isNull(value){
  var isNull=false;
  if(typeof value === "undefined" || value === null || value === "" ){
    isNull=true;
  }
  return isNull;
}
